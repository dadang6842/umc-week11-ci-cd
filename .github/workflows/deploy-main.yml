name: deploy-main

on:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source code
              uses: actions/checkout@v4

            - name: Upload source files to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "."
                  target: "/opt/app"
                  rm: true
                  strip_components: 0
                  exclude: |
                      .git
                      node_modules
                      .next
                      app.tar.gz

            - name: Deploy on EC2
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -e
                      cd /opt/app
                      npm ci --only=production

                      echo "[Unit]
                      Description=UMC 8th Project
                      After=network.target

                      [Service]
                      User=ubuntu
                      ExecStart=/usr/bin/npm run dev --prefix /opt/app/
                      Restart=always

                      [Install]
                      WantedBy=multi-user.target" | sudo tee /etc/systemd/system/app.service

                      sudo systemctl daemon-reload
                      sudo systemctl enable app
                      sudo systemctl restart app
